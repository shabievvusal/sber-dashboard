<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      /* –£–º–µ–Ω—å—à–∞–µ–º —à–∏—Ä–∏–Ω—É —Å—Ç–æ–ª–±—Ü–∞ –ö–æ–º–ø–∞–Ω–∏—è –ø—Ä–∏–º–µ—Ä–Ω–æ –≤–¥–≤–æ–µ */
      th.col-company, td.col-company { width: 10%; white-space: nowrap; }
      
      /* –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü –ö–æ–º–ø–∞–Ω–∏—è –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ */
      body.manager-view th.col-company,
      body.manager-view td.col-company,
      body.manager-view #hourly-company-header,
      body.manager-view #hourly-table tbody td:first-child,
      body.manager-view #hourly-total-company {
        display: none;
      }
      
      /* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω —Ç–∞–π–º–ª–∞–π–Ω–∞ –ø—Ä–æ—Å—Ç–æ–µ–≤ */
      #timeline-container {
        max-width: 100%;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      
      /* –°—Ç–∏–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ */
      .timeline-track {
        height: 60px !important;
        margin-bottom: 25px;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
        border: 2px solid #e9ecef !important;
        border-radius: 12px !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        position: relative;
        overflow: visible !important;
      }
      
      .timeline-track:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      
      /* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ –ø—Ä–æ—Å—Ç–æ–µ–≤ */
      .timeline-block {
        font-size: 0.75rem !important;
        font-weight: 600 !important;
        border-radius: 8px !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      
      .timeline-block:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      
      /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø—Ä–æ—Å—Ç–æ–µ–≤ */
      .break-short { background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%) !important; }
      .break-medium { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%) !important; }
      .break-long { background: linear-gradient(135deg, #fd7e14 0%, #e8590c 100%) !important; }
      .break-critical { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important; }
      
      /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ */
      .employee-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }
      
      .employee-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      }
      
      .company-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 8px;
      }
      
      .approver-name {
        font-size: 0.9rem;
        font-weight: 600;
        color: #495057;
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        padding: 6px 12px;
        border-radius: 20px;
        display: inline-block;
        margin-bottom: 15px;
      }
      
      .stats-info {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 12px 16px;
        border-radius: 8px;
        border-left: 4px solid #007bff;
      }
      
      .stats-info .stat-item {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 4px;
      }
      
      .stats-info .stat-item:last-child {
        margin-bottom: 0;
        font-weight: 600;
        color: #495057;
      }
      
      /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —É—Ç–≤–µ—Ä–¥–∏—Ç–µ–ª—è */
      .approver-results {
        margin-top: 8px;
        padding: 8px 12px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        opacity: 0;
        transform: translateY(-5px);
        transition: all 0.3s ease;
      }

      /* –ó–∞–∫—Ä–µ–ø–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ */
      #results-table thead th {
        position: sticky;
        top: 0;
        z-index: 3; /* –ø–æ–≤–µ—Ä—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ç–∞–±–ª–∏—Ü—ã */
        background: #ffffff;
        box-shadow: 0 2px 0 rgba(0,0,0,0.04);
      }
      
      /* –ó–∞–∫—Ä–µ–ø–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã "–ü–æ —á–∞—Å–∞–º" –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ */
      #hourly-table thead th {
        position: sticky;
        top: 0;
        z-index: 5; /* –ø–æ–≤–µ—Ä—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ç–∞–±–ª–∏—Ü—ã */
        background: #ffffff;
        box-shadow: 0 2px 0 rgba(0,0,0,0.04);
      }
      
      /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –∏ –∫—É–±–∫–æ–≤ */
      .row-number {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        border-radius: 6px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border: 2px solid #60a5fa;
        box-shadow: 0 2px 4px rgba(37, 99, 235, 0.4);
        font-weight: 700;
        font-size: 0.85rem;
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
      }
      
      .trophy-icon {
        font-size: 1.5rem;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.6));
        display: inline-block;
      }
      
      .trophy-icon.gold {
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }

      .approver-results.show {
        opacity: 1;
        transform: translateY(0);
      }

      .approver-results h6 {
        margin-bottom: 8px;
        color: #495057;
        font-weight: 600;
        font-size: 0.9rem;
      }

      /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —è—á–µ–µ–∫ –ø–æ —á–∞—Å–∞–º, –µ—Å–ª–∏ –∑–∞–¥–∞—á < 55 */
      #hourly-table tbody td.low-hour {
        background-color: rgba(220, 53, 69, 0.08) !important;
      }
      /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —á–∞—Å–æ–≤—ã–µ —Å—Ç–æ–ª–±—Ü—ã */
      #hourly-table th.hour-col, #hourly-table td.hour-col {
        width: 48px;
        text-align: center;
        vertical-align: middle;
      }
      /* –°—Ç–∏–ª—å –∫–æ–ª–æ–Ω–∫–∏ –ò—Ç–æ–≥–æ: —Å–ø—Ä–∞–≤–∞ –∏ –∂–∏—Ä–Ω—ã–π */
      #hourly-table th.total-col, #hourly-table td.total-col {
        text-align: right;
        font-weight: 700;
        white-space: nowrap;
      }

      /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫ —Å –Ω–∏–∑–∫–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é (–ø–æ–≤–µ—Ä—Ö –ø–æ–ª–æ—Å–∞—Ç—ã—Ö —Å—Ç–∏–ª–µ–π —Ç–∞–±–ª–∏—Ü—ã) */
      #results-table tbody tr.low-speed td {
        background-color: rgba(220, 53, 69, 0.08) !important; /* –ª—ë–≥–∫–∏–π –∫—Ä–∞—Å–Ω—ã–π */
      }

      /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã —Å –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–π —à–∞–ø–∫–æ–π */
      #results-section {
        max-height: calc(100vh - 180px); /* –≤–∏–¥–∏–º–∞—è –æ–±–ª–∞—Å—Ç—å –º–∏–Ω—É—Å —à–∞–ø–∫–∞/–∫–Ω–æ–ø–∫–∏/–æ—Ç—Å—Ç—É–ø—ã */
        overflow-y: auto;
      }
      
      /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã "–ü–æ —á–∞—Å–∞–º" —Å –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–π —à–∞–ø–∫–æ–π */
      #hourly-section .table-responsive {
        max-height: calc(100vh - 180px); /* –≤–∏–¥–∏–º–∞—è –æ–±–ª–∞—Å—Ç—å –º–∏–Ω—É—Å —à–∞–ø–∫–∞/–∫–Ω–æ–ø–∫–∏/–æ—Ç—Å—Ç—É–ø—ã */
        overflow-y: auto;
      }

      .results-grid {
        display: flex;
        gap: 8px;
        flex-wrap: nowrap;
        justify-content: flex-start;
      }

      .result-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 4px 8px;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        min-width: 60px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }

      .result-item .label {
        font-size: 0.7rem;
        color: #6c757d;
        font-weight: 500;
        margin-bottom: 2px;
      }

      .result-item .value {
        font-size: 0.9rem;
        font-weight: 600;
        color: #495057;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-2">
          <h1 class="h4 m-0">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h1>
        </div>
        <a id="new-analysis-btn" class="btn btn-outline-secondary" href="{{ url_for('index') }}">–ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑</a>
      </div>

      {% if records and records|length > 0 %}
        <!-- –°–µ–∫—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–ª–∏ –ø—Ä–∏ hash=#results -->
        <div id="results-section" class="table-responsive">
          <table id="results-table" class="table table-sm table-striped align-middle">
            <thead>
              <tr>
                <th class="sortable" data-col="0" style="width: 80px; text-align: center;">‚Ññ</th>
                <th class="sortable col-company" data-col="1">–ö–æ–º–ø–∞–Ω–∏—è</th>
                <th class="sortable" data-col="2">–£—Ç–≤–µ—Ä–¥–∏–ª</th>
                <th class="sortable" data-col="3">–°–ó</th>
                <th class="sortable" data-col="4">–í–µ—Å</th>
                <th class="sortable" data-col="5">–®—Ç</th>
                <th class="sortable" data-col="6">—Å–∫–æ—Ä–æ—Å—Ç—å</th>
                <th class="sortable" data-col="7">–í—Ä–µ–º—è</th>
                <th class="sortable" data-col="8">15</th>
                <th class="sortable" data-col="9">30</th>
                <th class="sortable" data-col="10">45</th>
              </tr>
            </thead>
            <tbody id="results-tbody">
              {% for row in records %}
                {% set loop_index = loop.index0 %}
                {% set approver_name = row.get('–£—Ç–≤–µ—Ä–¥–∏–ª', '') %}
                {% set is_top3 = approver_name in top_leaders %}
                {% set top_position = top_leaders.index(approver_name) if is_top3 else -1 %}
                {% set trophy = 'ü•á' if top_position == 0 else ('ü•à' if top_position == 1 else ('ü•â' if top_position == 2 else '')) %}
                {% set trophy_class = 'gold' if top_position == 0 else ('silver' if top_position == 1 else ('bronze' if top_position == 2 else '')) %}
                <tr class="main-row{% if row['—Å–∫–æ—Ä–æ—Å—Ç—å'] is not none and (row['—Å–∫–æ—Ä–æ—Å—Ç—å']|float) < 1.2 %} low-speed{% endif %}" data-approver="{{ approver_name }}">
                  <td style="text-align: center; position: relative; width: 100px;">
                    {% if trophy %}
                      <span class="trophy-icon {{ trophy_class }}" title="{% if top_position == 0 %}ü•á 1 –º–µ—Å—Ç–æ (–∑–æ–ª–æ—Ç–æ){% elif top_position == 1 %}ü•à 2 –º–µ—Å—Ç–æ (—Å–µ—Ä–µ–±—Ä–æ){% else %}ü•â 3 –º–µ—Å—Ç–æ (–±—Ä–æ–Ω–∑–∞){% endif %}" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); z-index: 10;">{{ trophy }}</span>
                    {% endif %}
                    <div class="row-number" style="display: inline-block;">#{{ loop.index }}</div>
                  </td>
                  <td class="col-company">{{ row.get('–ö–æ–º–ø–∞–Ω–∏—è', '') }}</td>
                  <td>{{ approver_name }}</td>
                  <td>{{ row['–°–ó'] }}</td>
                  <td>{{ row['–í–µ—Å']|round(0)|int }}</td>
                  <td>{{ row['–®—Ç'] }}</td>
                  <td>{{ row['—Å–∫–æ—Ä–æ—Å—Ç—å'] }}</td>
                  <td>{{ row['–í—Ä–µ–º—è'] }}</td>
                  <td>
                    <button class="btn btn-link p-0" data-approver="{{ row['–£—Ç–≤–µ—Ä–¥–∏–ª'] }}" data-bucket="15">
                      {{ row['b15'] }}
                    </button>
                  </td>
                  <td>
                    <button class="btn btn-link p-0" data-approver="{{ row['–£—Ç–≤–µ—Ä–¥–∏–ª'] }}" data-bucket="30">
                      {{ row['b30'] }}
                    </button>
                  </td>
                  <td>
                    <button class="btn btn-link p-0" data-approver="{{ row['–£—Ç–≤–µ—Ä–¥–∏–ª'] }}" data-bucket="45">
                      {{ row['b45'] }}
                    </button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div id="downtimes-section" class="d-none">
          <div class="mb-2 small text-muted">–¢–∞–π–º–ª–∞–π–Ω –ø—Ä–æ—Å—Ç–æ–µ–≤ (09:00‚Äì21:00). –¶–≤–µ—Ç–∞: 15‚Äì30 –º–∏–Ω (–∂—ë–ª—Ç—ã–π), 30‚Äì45 (–æ—Ä–∞–Ω–∂–µ–≤—ã–π), >45 (–∫—Ä–∞—Å–Ω—ã–π), 10‚Äì15 (—Å–µ—Ä—ã–π).</div>
          <div id="timeline-container" class="vstack gap-3"></div>
        </div>
        <div id="hourly-section" class="d-none mt-3">
          <div class="table-responsive">
            <table id="hourly-table" class="table table-sm table-striped align-middle">
              <thead>
                <tr>
                  <th class="text-nowrap" style="width: 80px; text-align: center;">‚Ññ</th>
                  <th id="hourly-company-header" class="text-nowrap">–ö–æ–º–ø–∞–Ω–∏—è</th>
                  <th class="text-nowrap">–£—Ç–≤–µ—Ä–¥–∏–ª</th>
                  <th class="text-nowrap">–ó–∞–Ω—è—Ç–æ—Å—Ç—å</th>
                  <th class="hour-col">9</th>
                  <th class="hour-col">10</th>
                  <th class="hour-col">11</th>
                  <th class="hour-col">12</th>
                  <th class="hour-col">13</th>
                  <th class="hour-col">14</th>
                  <th class="hour-col">15</th>
                  <th class="hour-col">16</th>
                  <th class="hour-col">17</th>
                  <th class="hour-col">18</th>
                  <th class="hour-col">19</th>
                  <th class="hour-col">20</th>
                  <th class="text-nowrap total-col">–ò—Ç–æ–≥–æ</th>
                </tr>
              </thead>
              <tbody id="hourly-tbody"></tbody>
              <tfoot>
                <tr id="hourly-totals-row">
                  <td class="fw-bold"></td>
                  <td id="hourly-total-company" class="fw-bold"></td>
                  <td class="fw-bold">–ò—Ç–æ–≥–æ</td>
                  <td class="fw-bold" id="hourly-total-approvers">0</td>
                  <td></td>
                  <td class="hour-col" id="hourly-total-9">0</td>
                  <td class="hour-col" id="hourly-total-10">0</td>
                  <td class="hour-col" id="hourly-total-11">0</td>
                  <td class="hour-col" id="hourly-total-12">0</td>
                  <td class="hour-col" id="hourly-total-13">0</td>
                  <td class="hour-col" id="hourly-total-14">0</td>
                  <td class="hour-col" id="hourly-total-15">0</td>
                  <td class="hour-col" id="hourly-total-16">0</td>
                  <td class="hour-col" id="hourly-total-17">0</td>
                  <td class="hour-col" id="hourly-total-18">0</td>
                  <td class="hour-col" id="hourly-total-19">0</td>
                  <td class="hour-col" id="hourly-total-20">0</td>
                  <td class="total-col" id="hourly-grand-total">0</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      {% else %}
        <div class="alert alert-info">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</div>
      {% endif %}
    </div>
  <!-- –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ JSON-—Å–∫—Ä–∏–ø—Ç—ã, —á—Ç–æ–±—ã JS –æ—Å—Ç–∞–≤–∞–ª—Å—è –≤–∞–ª–∏–¥–Ω—ã–º –¥–ª—è –ª–∏–Ω—Ç–µ—Ä–∞ -->
  <script id="data-breaks" type="application/json">{{ breaks_json|safe if breaks_json else '{}' }}</script>
  <script id="data-records" type="application/json">{{ records_json|safe if records_json else '[]' }}</script>
  <script id="data-hourly" type="application/json">{{ hourly_json|safe if hourly_json else '{}' }}</script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ hash –≤ URL (#results, #hourly, #downtimes)
    // –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ switchSectionByHash –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
    window.showDowntimes = function() {
      const resultsSection = document.getElementById('results-section');
      const downtimesSection = document.getElementById('downtimes-section');
      const hourlySection = document.getElementById('hourly-section');
      if (!(resultsSection && downtimesSection && hourlySection)) return;
      resultsSection.classList.add('d-none');
      hourlySection.classList.add('d-none');
      downtimesSection.classList.remove('d-none');
      if (typeof buildDowntimesTimeline === 'function') {
        setTimeout(() => buildDowntimesTimeline(), 50);
      }
      console.log('showDowntimes');
    };
    window.showResults = function() {
      const resultsSection = document.getElementById('results-section');
      const downtimesSection = document.getElementById('downtimes-section');
      const hourlySection = document.getElementById('hourly-section');
      if (!(resultsSection && downtimesSection && hourlySection)) return;
      downtimesSection.classList.add('d-none');
      hourlySection.classList.add('d-none');
      resultsSection.classList.remove('d-none');
      console.log('showResults');
    };
    window.showHourly = function() {
      const resultsSection = document.getElementById('results-section');
      const downtimesSection = document.getElementById('downtimes-section');
      const hourlySection = document.getElementById('hourly-section');
      if (!(resultsSection && downtimesSection && hourlySection)) return;
      resultsSection.classList.add('d-none');
      downtimesSection.classList.add('d-none');
      hourlySection.classList.remove('d-none');
      if (typeof renderHourlyTable === 'function') {
        setTimeout(() => renderHourlyTable(), 50);
      }
      console.log('showHourly');
    };

    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑" –∏ —Å—Ç–æ–ª–±–µ—Ü "–ö–æ–º–ø–∞–Ω–∏—è" –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä company_name)
    function setupManagerView() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const companyName = urlParams.get('company_name');
        if (companyName) {
          // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑"
          const newAnalysisBtn = document.getElementById('new-analysis-btn');
          if (newAnalysisBtn) {
            newAnalysisBtn.style.display = 'none';
          } else {
            // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–∑–∂–µ
            setTimeout(setupManagerView, 100);
          }
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —Å—Ç–æ–ª–±—Ü–∞ "–ö–æ–º–ø–∞–Ω–∏—è"
          document.body.classList.add('manager-view');
        }
      } catch (e) {
        console.error('Error setting up manager view:', e);
      }
    }
    
    // –í—ã–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É –∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupManagerView);
    } else {
      setupManagerView();
    }
    
    document.addEventListener('DOMContentLoaded', function () {
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–¥ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
      setupManagerView();
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω—ã, —Ç–∞–∫ –∫–∞–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –≤–∫–ª–∞–¥–∫–∏ –≤ React
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ hash (–±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏–∏-–æ–±–µ—Ä—Ç–∫–∏)
      let hashProcessed = false;
      function switchSectionByHash(force) {
        // –ï—Å–ª–∏ hash —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–Ω–æ–≤–∞ (–µ—Å–ª–∏ –Ω–µ —Ñ–æ—Ä—Å–∏—Ä—É–µ—Ç—Å—è)
        if (hashProcessed && !force) {
          console.log('Hash already processed, skipping');
          return;
        }
        
        const hash = window.location.hash;
        console.log('Switching by hash:', hash, 'force:', force);
        
        const resultsSection = document.getElementById('results-section');
        const downtimesSection = document.getElementById('downtimes-section');
        const hourlySection = document.getElementById('hourly-section');
        
        if (!(resultsSection && downtimesSection && hourlySection)) {
          console.log('Sections not ready yet, retrying...');
          setTimeout(() => switchSectionByHash(force), 50);
          return;
        }
        
        // –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
        resultsSection.classList.add('d-none');
        downtimesSection.classList.add('d-none');
        hourlySection.classList.add('d-none');
        
        // –ó–∞—Ç–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Å–µ–∫—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é, –±–µ–∑ –≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–π-–æ–±–µ—Ä—Ç–æ–∫
        if (hash === '#hourly') {
          hourlySection.classList.remove('d-none');
          console.log('Showing hourly section');
          if (typeof renderHourlyTable === 'function') {
            setTimeout(() => renderHourlyTable(), 50);
          }
          hashProcessed = true;
        } else if (hash === '#downtimes') {
          downtimesSection.classList.remove('d-none');
          console.log('Showing downtimes section');
          if (typeof buildDowntimesTimeline === 'function') {
            setTimeout(() => buildDowntimesTimeline(), 50);
          }
          hashProcessed = true;
        } else {
          // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (#results –∏–ª–∏ –±–µ–∑ hash)
          resultsSection.classList.remove('d-none');
          console.log('Showing results section');
          hashProcessed = true;
        }
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º hash –≤ URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–æ–¥–∏–Ω —Ä–∞–∑ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏)
      // –ñ–¥–µ–º, –ø–æ–∫–∞ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON-—Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ DOM –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
      let initDone = false;
      function initHashSwitching() {
        if (initDone) return;
        
        const resultsSection = document.getElementById('results-section');
        const downtimesSection = document.getElementById('downtimes-section');
        const hourlySection = document.getElementById('hourly-section');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Å–µ–∫—Ü–∏–∏ –∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        const brNode = document.getElementById('data-breaks');
        const recNode = document.getElementById('data-records');
        
        if (resultsSection && downtimesSection && hourlySection && brNode && recNode) {
          initDone = true;
          switchSectionByHash(true);
        } else {
          // –ï—Å–ª–∏ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–æ, –ø–æ–≤—Ç–æ—Ä—è–µ–º —á–µ—Ä–µ–∑ 50–º—Å
          setTimeout(initHashSwitching, 50);
        }
      }
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(initHashSwitching, 100);
        });
      } else {
        setTimeout(initHashSwitching, 100);
      }
      
      // –¢–∞–∫–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ hash (–µ—Å–ª–∏ hash –º–µ–Ω—è–µ—Ç—Å—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
      window.addEventListener('hashchange', () => {
        console.log('Hash changed, processing...');
        hashProcessed = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ–±—ã –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ–≤—ã–π hash
        setTimeout(() => {
          switchSectionByHash(true);
        }, 10);
      });
      
      // –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ä—ã–≤–æ–≤ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (—á–∏—Ç–∞–µ–º –∏–∑ JSON-—Å–∫—Ä–∏–ø—Ç–æ–≤)
      const brNode = document.getElementById('data-breaks');
      const recNode = document.getElementById('data-records');
      const hrNode = document.getElementById('data-hourly');
      let breaksMap = {};
      let recordsData = [];
      let hourlyMap = {};
      try { breaksMap = JSON.parse((brNode && brNode.textContent) ? brNode.textContent : '{}'); } catch(e) { console.error('breaks JSON parse error', e); }
      try { recordsData = JSON.parse((recNode && recNode.textContent) ? recNode.textContent : '[]'); } catch(e) { console.error('records JSON parse error', e); recordsData = []; }
      try { hourlyMap = JSON.parse((hrNode && hrNode.textContent) ? hrNode.textContent : '{}'); } catch(e) { console.error('hourly JSON parse error', e); }
      const topLeadersNode = document.getElementById('data-top-leaders');
      let topLeaders = [];
      try { topLeaders = JSON.parse((topLeadersNode && topLeadersNode.textContent) ? topLeadersNode.textContent : '[]'); } catch(e) { console.error('top leaders JSON parse error', e); }
    function updateHourlyTotals(filteredRecords) {
      const hours = [9,10,11,12,13,14,15,16,17,18,19,20];
      const totals = Object.fromEntries(hours.map(h => [h, 0]));
      let grand = 0;
      (filteredRecords || []).forEach(rec => {
        const approver = rec['–£—Ç–≤–µ—Ä–¥–∏–ª'];
        const byHour = (hourlyMap && hourlyMap[approver]) ? hourlyMap[approver] : {};
        hours.forEach(h => {
          const v = Number(byHour[String(h)] ?? byHour[h] ?? 0) || 0;
          totals[h] += v;
          grand += v;
        });
      });
      const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = String(val); };
      set('hourly-total-approvers', (filteredRecords || []).length);
      hours.forEach(h => set(`hourly-total-${h}`, totals[h]));
      set('hourly-grand-total', grand);
    }

    function renderHourlyTable() {
      const tbody = document.getElementById('hourly-tbody');
      if (!tbody) return;
      const hours = [9,10,11,12,13,14,15,16,17,18,19,20];
      const rows = [];
      // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ company_name –∏–∑ URL, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
      const urlParams = new URLSearchParams(window.location.search);
      const companyNameFromUrl = urlParams.get('company_name');
      let filtered = (recordsData || []);
      if (companyNameFromUrl) {
        filtered = filtered.filter(rec => (rec['–ö–æ–º–ø–∞–Ω–∏—è'] || '').trim() === companyNameFromUrl);
      }
      const isManagerView = document.body.classList.contains('manager-view');
      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ —É—Ç–≤–µ—Ä–¥–∏—Ç–µ–ª—é –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã "–ü–æ —á–∞—Å–∞–º"
      const groupedByApprover = {};
      filtered.forEach(rec => {
        // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –∑–∞–ø–∏—Å–∏ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∫–ª—é—á–µ–π
        let approver = String(rec['–£—Ç–≤–µ—Ä–¥–∏–ª'] || rec['—É—Ç–≤–µ—Ä–¥–∏–ª'] || '').trim();
        let company = String(rec['–ö–æ–º–ø–∞–Ω–∏—è'] || rec['–∫–æ–º–ø–∞–Ω–∏—è'] || '').trim();
        let assignment = String(rec['–ó–∞–Ω—è—Ç–æ—Å—Ç—å'] || rec['–∑–∞–Ω—è—Ç–æ—Å—Ç—å'] || '').trim() || '–¢–°–î';
        
        // –ï—Å–ª–∏ —É—Ç–≤–µ—Ä–¥–∏—Ç–µ–ª—å –ø—É—Å—Ç–æ–π –∏–ª–∏ —Ä–∞–≤–µ–Ω "–¢–°–î", –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç—É –∑–∞–ø–∏—Å—å
        if (!approver || approver === '–¢–°–î') {
          return;
        }
        
        // –ï—Å–ª–∏ –µ—â–µ –Ω–µ –±—ã–ª–æ –∑–∞–ø–∏—Å–∏ –¥–ª—è —ç—Ç–æ–≥–æ —É—Ç–≤–µ—Ä–¥–∏—Ç–µ–ª—è, —Å–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—É
        if (!groupedByApprover[approver]) {
          groupedByApprover[approver] = {
            approver: approver,
            company: company,
            assignment: assignment
          };
        } else {
          // –ï—Å–ª–∏ –∑–∞–Ω—è—Ç–æ—Å—Ç—å –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–µ
          if (groupedByApprover[approver].assignment === '–¢–°–î' && assignment !== '–¢–°–î') {
            groupedByApprover[approver].assignment = assignment;
          }
        }
      });
      
      // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ —É—Ç–≤–µ—Ä–¥–∏—Ç–µ–ª—è —Å –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π –∏ –∫—É–±–∫–∞–º–∏
      let rowNumber = 1;
      Object.values(groupedByApprover).forEach(group => {
        const approver = group.approver;
        const company = group.company;
        const assignment = group.assignment;
        const byHour = (hourlyMap && hourlyMap[approver]) ? hourlyMap[approver] : {};
        let total = 0;
        const tds = hours.map(h => {
          const valRaw = (byHour[String(h)] ?? byHour[h] ?? 0);
          const valNum = Number(valRaw) || 0;
          total += valNum;
          const cls = valNum < 55 ? ' class="low-hour"' : '';
          return `<td class="hour-col"${cls}>${valNum}</td>`;
        }).join('');
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ —Ç–æ–ø-3 –¥–ª—è –∫—É–±–∫–∞
        const globalIndex = topLeaders.indexOf(approver);
        const trophyPosition = globalIndex === 0 ? 'gold' : globalIndex === 1 ? 'silver' : globalIndex === 2 ? 'bronze' : null;
        const trophy = trophyPosition === 'gold' ? 'ü•á' : trophyPosition === 'silver' ? 'ü•à' : trophyPosition === 'bronze' ? 'ü•â' : '';
        const trophyHtml = trophy ? `<span class="trophy-icon ${trophyPosition}" title="${trophyPosition === 'gold' ? 'ü•á 1 –º–µ—Å—Ç–æ (–∑–æ–ª–æ—Ç–æ)' : trophyPosition === 'silver' ? 'ü•à 2 –º–µ—Å—Ç–æ (—Å–µ—Ä–µ–±—Ä–æ)' : 'ü•â 3 –º–µ—Å—Ç–æ (–±—Ä–æ–Ω–∑–∞)'}" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); z-index: 10;">${trophy}</span>` : '';
        // –ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ —Å –∫—É–±–∫–æ–º (–Ω–æ–º–µ—Ä –ø–æ —Ü–µ–Ω—Ç—Ä—É, –∫—É–±–æ–∫ –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω)
        const numberCell = `<td style="text-align: center; width: 100px; position: relative;">${trophyHtml}<div class="row-number" style="display: inline-block;">#${rowNumber}</div></td>`;
        // –î–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—É—é —è—á–µ–π–∫—É –∫–æ–º–ø–∞–Ω–∏–∏, —á—Ç–æ–±—ã —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
        const companyCell = isManagerView ? '<td class="company-cell" style="display: none;"></td>' : `<td class="company-cell">${company}</td>`;
        rows.push(`<tr>${numberCell}${companyCell}<td>${approver}</td><td>${assignment}</td>${tds}<td class="total-col">${total}</td></tr>`);
        rowNumber++;
      });
      tbody.innerHTML = rows.join('');
      updateHourlyTotals(filtered);
    }

    // –§–∏–ª—å—Ç—Ä –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü–æ —á–∞—Å–∞–º" (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –º–µ–Ω–µ–¥–∂–µ—Ä)
    let hourlyCompanyFilter = null;
    document.addEventListener('click', (e) => {
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–ª–∏–∫–∞ –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
      if (document.body.classList.contains('manager-view')) return;
      const cell = e.target.closest('#hourly-table tbody td.company-cell');
      if (!cell) return;
      const company = (cell.innerText || '').trim();
      hourlyCompanyFilter = (hourlyCompanyFilter === company ? null : company);
      const tbody = document.getElementById('hourly-tbody');
      if (!tbody) return;
      const hours = [9,10,11,12,13,14,15,16,17,18,19,20];
      const rows = [];
      const filtered = (recordsData || [])
        .filter(rec => !hourlyCompanyFilter || (rec['–ö–æ–º–ø–∞–Ω–∏—è'] || '').trim() === hourlyCompanyFilter);
      const isManagerView = document.body.classList.contains('manager-view');
      let rowNumber = 1;
      filtered.forEach(rec => {
          // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –∑–∞–ø–∏—Å–∏
          let approver = String(rec['–£—Ç–≤–µ—Ä–¥–∏–ª'] || '').trim();
          const company = String(rec['–ö–æ–º–ø–∞–Ω–∏—è'] || '').trim();
          let assignment = String(rec['–ó–∞–Ω—è—Ç–æ—Å—Ç—å'] || '').trim() || '–¢–°–î';
          
          // –ï—Å–ª–∏ approver –ø—É—Å—Ç–æ–π –∏–ª–∏ —Ä–∞–≤–µ–Ω "–¢–°–î", –≤–æ–∑–º–æ–∂–Ω–æ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–ø—É—Ç–∞–Ω—ã
          if (!approver || approver === '–¢–°–î' || approver === assignment) {
            // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —É—Ç–≤–µ—Ä–¥–∏—Ç–µ–ª—è
            const allKeys = Object.keys(rec);
            for (const key of allKeys) {
              const val = String(rec[key] || '').trim();
              // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –∏–º—è —É—Ç–≤–µ—Ä–¥–∏—Ç–µ–ª—è (—Å–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Ñ–∏—Å –∏–ª–∏ –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã)
              if (val && val !== '–¢–°–î' && val !== assignment && (val.includes('-') || /^[A-Z–ê-–Ø]/.test(val))) {
                approver = val;
                break;
              }
            }
          }
          
          // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞—à–ª–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤–æ–µ –Ω–µ–ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ "–¢–°–î"
          if (!approver || approver === '–¢–°–î') {
            const allValues = Object.values(rec).map(v => String(v || '').trim()).filter(v => v && v !== '–¢–°–î' && v !== assignment);
            if (allValues.length > 0) {
              approver = allValues[0];
            }
          }
          
          const byHour = (hourlyMap && hourlyMap[approver]) ? hourlyMap[approver] : {};
          let total = 0;
          const tds = hours.map(h => {
            const valRaw = (byHour[String(h)] ?? byHour[h] ?? 0);
            const valNum = Number(valRaw) || 0;
            total += valNum;
            const cls = valNum < 55 ? ' class="hour-col low-hour"' : ' class="hour-col"';
            return `<td${cls}>${valNum}</td>`;
          }).join('');
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ —Ç–æ–ø-3 –¥–ª—è –∫—É–±–∫–∞
          const globalIndex = topLeaders.indexOf(approver || '');
          const trophyPosition = globalIndex === 0 ? 'gold' : globalIndex === 1 ? 'silver' : globalIndex === 2 ? 'bronze' : null;
          const trophy = trophyPosition === 'gold' ? 'ü•á' : trophyPosition === 'silver' ? 'ü•à' : trophyPosition === 'bronze' ? 'ü•â' : '';
          const trophyHtml = trophy ? `<span class="trophy-icon ${trophyPosition}" title="${trophyPosition === 'gold' ? 'ü•á 1 –º–µ—Å—Ç–æ (–∑–æ–ª–æ—Ç–æ)' : trophyPosition === 'silver' ? 'ü•à 2 –º–µ—Å—Ç–æ (—Å–µ—Ä–µ–±—Ä–æ)' : 'ü•â 3 –º–µ—Å—Ç–æ (–±—Ä–æ–Ω–∑–∞)'}" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); z-index: 10;">${trophy}</span>` : '';
          // –ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ —Å –∫—É–±–∫–æ–º (–Ω–æ–º–µ—Ä –ø–æ —Ü–µ–Ω—Ç—Ä—É, –∫—É–±–æ–∫ –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω)
          const numberCell = `<td style="text-align: center; width: 100px; position: relative;">${trophyHtml}<div class="row-number" style="display: inline-block;">#${rowNumber}</div></td>`;
          // –î–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—É—é —è—á–µ–π–∫—É –∫–æ–º–ø–∞–Ω–∏–∏, —á—Ç–æ–±—ã —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
          const companyCell = isManagerView ? '<td class="company-cell" style="display: none;"></td>' : `<td class="company-cell">${company}</td>`;
          rows.push(`<tr>${numberCell}${companyCell}<td>${approver || ''}</td><td>${assignment}</td>${tds}<td class="total-col">${total}</td></tr>`);
          rowNumber++;
        });
      tbody.innerHTML = rows.join('');
      updateHourlyTotals(filtered);
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    function showApproverResults(approver, container) {
      // –ù–∞—Ö–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ recordsData
      const employeeData = recordsData.find(record => record['–£—Ç–≤–µ—Ä–¥–∏–ª'] === approver);
      if (!employeeData) return;
      
      // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      const resultsContainer = document.createElement('div');
      resultsContainer.className = 'approver-results';
      resultsContainer.innerHTML = `
        <h6>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã: ${approver}</h6>
        <div class="results-grid">
          <div class="result-item">
            <div class="label">–°–ó</div>
            <div class="value">${employeeData['–°–ó'] || 0}</div>
          </div>
          <div class="result-item">
            <div class="label">–í–µ—Å</div>
            <div class="value">${Math.round(Number(employeeData['–í–µ—Å'] || 0))}</div>
          </div>
          <div class="result-item">
            <div class="label">–®—Ç</div>
            <div class="value">${employeeData['–®—Ç'] || 0}</div>
          </div>
          <div class="result-item">
            <div class="label">–ú–∏–Ω</div>
            <div class="value">${employeeData['—Å–∫–æ—Ä–æ—Å—Ç—å'] || 0}</div>
          </div>
          <div class="result-item">
            <div class="label">–í —Ä–∞–±–æ—Ç–µ</div>
            <div class="value">${employeeData['–í—Ä–µ–º—è'] || '00:00'}</div>
          </div>
        </div>
      `;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ—Å–ª–µ —Ç–∞–π–º–ª–∞–π–Ω–∞
      container.appendChild(resultsContainer);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
      setTimeout(() => {
        resultsContainer.classList.add('show');
      }, 100);
    }

    function formatBreakItem(item) {
      const dur = item.duration || '';
      const before = item.before || {};
      const after = item.after || {};

      const pickTime = (obj) => {
        // –ë–µ—Ä—ë–º –∏–º–µ–Ω–Ω–æ –≤—Ä–µ–º—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –∏–∑ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –∫–æ–ª–æ–Ω–∫–∏ backend'–∞
        const raw = obj['confirm_time'] || obj['–í—Ä–µ–º—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è'] || '';
        if (!raw) return '';
        const m = String(raw).match(/\b(\d{1,2}:\d{2})(?::\d{2})?\b/);
        return m ? m[1] : String(raw);
      };

      const startTime = pickTime(before);
      const endTime = pickTime(after);
      return `<div>–ü–µ—Ä–µ—Ä—ã–≤:</div><div>${dur}: ${startTime} -- ${endTime}</div>`;
    }

    function ensureAndRenderDetailsRow(approver, bucket) {
      // –ò—â–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å—Ç—Ä–æ–∫–∞ –¥–µ—Ç–∞–ª–µ–π; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
      const mainRow = document.querySelector(`tr.main-row[data-approver="${approver}"]`);
      if (!mainRow) return;
      const selector = `tr.details-row[data-approver="${approver}"][data-bucket="${bucket}"]`;
      let row = document.querySelector(selector);
      let container;
      if (!row) {
        row = document.createElement('tr');
        row.className = 'details-row';
        row.setAttribute('data-approver', approver);
        row.setAttribute('data-bucket', String(bucket));
        const td = document.createElement('td');
        td.colSpan = 11; // –£–≤–µ–ª–∏—á–µ–Ω–æ –Ω–∞ 1 –∏–∑-–∑–∞ –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ ‚Ññ
        container = document.createElement('div');
        container.className = 'small';
        td.appendChild(container);
        row.appendChild(td);
        mainRow.parentNode.insertBefore(row, mainRow.nextSibling);
      } else {
        container = row.querySelector('td > div.small');
      }
      const all = breaksMap[approver] || [];
      const items = all.filter(b => Number(b.bucket) === Number(bucket));
      if (items.length === 0) {
        container.innerText = '–ù–µ—Ç –ø–µ—Ä–µ—Ä—ã–≤–æ–≤.';
        return row;
      }
      container.innerHTML = '<ul class="mb-0">' + items.map(i => `<li>${formatBreakItem(i)}</li>`).join('') + '</ul>';
      return row;
    }

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-approver][data-bucket]');
      if (!btn) return;
      e.preventDefault();
      const approver = btn.getAttribute('data-approver');
      const bucket = btn.getAttribute('data-bucket');
      // –°–æ–∑–¥–∞—ë–º —Å—Ç—Ä–æ–∫—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
      const row = ensureAndRenderDetailsRow(approver, bucket);
      if (!row) return;
      const willShow = row.classList.contains('d-none');
      // –°–∫—Ä—ã—Ç—å –¥—Ä—É–≥–∏–µ –¥–µ—Ç–∞–ª–∏ —ç—Ç–æ–≥–æ —É—Ç–≤–µ—Ä–¥–∏—Ç–µ–ª—è
      document.querySelectorAll(`tr.details-row[data-approver="${approver}"]`).forEach(r => r.classList.add('d-none'));
      if (willShow) row.classList.remove('d-none');
    });

    // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ç–∞–π–º–ª–∞–π–Ω–∞ "–ü—Ä–æ—Å—Ç–æ–∏"
    function buildDowntimesTimeline() {
      console.log('buildDowntimesTimeline –≤—ã–∑–≤–∞–Ω–∞');
      const container = document.getElementById('timeline-container');
      if (!container) {
        console.log('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä timeline-container –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
      }
      console.log('–û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä');
      container.innerHTML = '';
      const approverToCompany = {};
      const approverToAssignment = {};
      // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ company_name –∏–∑ URL, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
      const urlParams = new URLSearchParams(window.location.search);
      const companyNameFromUrl = urlParams.get('company_name');
      let filteredRecords = (recordsData || []);
      if (companyNameFromUrl) {
        filteredRecords = filteredRecords.filter(r => (r['–ö–æ–º–ø–∞–Ω–∏—è'] || '').trim() === companyNameFromUrl);
      }
      filteredRecords.forEach(r => {
        approverToCompany[r['–£—Ç–≤–µ—Ä–¥–∏–ª']] = r['–ö–æ–º–ø–∞–Ω–∏—è'] || '';
        const a = (r['–ó–∞–Ω—è—Ç–æ—Å—Ç—å'] || '–¢–°–î');
        approverToAssignment[r['–£—Ç–≤–µ—Ä–¥–∏–ª']] = (typeof a === 'string' ? a : String(a)).trim() || '–¢–°–î';
      });
      console.log('–î–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–π:', approverToCompany);

      const timeToMinutes = (t) => {
        if (!t) return null;
        const parts = String(t).split(':').map(n => parseInt(n, 10));
        if (parts.length < 2) return null;
        const h = parts[0] || 0, m = parts[1] || 0, s = parts[2] || 0;
        return h * 60 + m + Math.floor(s / 60);
      };

      const pickRawTime = (obj) => {
        const raw = obj['confirm_time'] || obj['–í—Ä–µ–º—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è'] || '';
        if (!raw) return '';
        const m = String(raw).match(/\b(\d{1,2}:\d{2})(?::\d{2})?\b/);
        return m ? m[1] : '';
      };

      // –û—Å—å 09:00‚Äì21:00
      const dayStartMin = 9 * 60;
      const dayEndMin = 21 * 60;
      const totalMinutes = dayEndMin - dayStartMin; // 12 —á–∞—Å–æ–≤

      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º
      const companiesMap = {};
      Object.keys(breaksMap || {}).forEach(approver => {
        const company = approverToCompany[approver] || '–ë–µ–∑ –∫–æ–º–ø–∞–Ω–∏–∏';
        if (!companiesMap[company]) {
          companiesMap[company] = [];
        }
        companiesMap[company].push({
          approver,
          breaks: breaksMap[approver] || []
        });
      });

      // –°–æ–∑–¥–∞–µ–º —Ç–∞–π–º–ª–∞–π–Ω—ã –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º
      Object.keys(companiesMap).forEach(company => {
        const employees = companiesMap[company];
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–º–ø–∞–Ω–∏–∏
        const companyHeader = document.createElement('div');
        companyHeader.className = 'mb-3';
        companyHeader.style.fontSize = '1.2rem';
        companyHeader.style.fontWeight = '700';
        companyHeader.style.color = '#2c3e50';
        companyHeader.style.borderBottom = '2px solid #007bff';
        companyHeader.style.paddingBottom = '8px';
        companyHeader.innerHTML = `${company}`;
        container.appendChild(companyHeader);
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–∞–π–º–ª–∞–π–Ω–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏
        const companyContainer = document.createElement('div');
        companyContainer.className = 'company-timelines mb-4';
        container.appendChild(companyContainer);
        
        // –°–æ–∑–¥–∞–µ–º —Ç–∞–π–º–ª–∞–π–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏
        employees.forEach(employee => {
          const { approver, breaks: list } = employee;
          if (!list.length) return;

          // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ–π —Å—Ç—Ä–æ–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
          const employeeRow = document.createElement('div');
          employeeRow.className = 'employee-row mb-2';
          
          // –¢—Ä–µ–∫ –≤—Ä–µ–º–µ–Ω–∏
          const track = document.createElement('div');
          track.className = 'position-relative border rounded py-2 px-2 timeline-track';
          track.style.background = '#f8f9fa';
          track.style.overflow = 'hidden';
          track.style.width = '100%';
          
          // –ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Ç–∞–π–º–ª–∞–π–Ω–∞ —Å–ª–µ–≤–∞
          const nameDiv = document.createElement('div');
          nameDiv.className = 'position-absolute';
          nameDiv.style.left = '10px';
          nameDiv.style.top = '50%';
          nameDiv.style.transform = 'translateY(-50%)';
          nameDiv.style.fontSize = '0.8rem';
          nameDiv.style.fontWeight = '600';
          nameDiv.style.color = '#495057';
          nameDiv.style.cursor = 'pointer';
          nameDiv.style.padding = '4px 8px';
          nameDiv.style.borderRadius = '4px';
          nameDiv.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
          nameDiv.style.transition = 'all 0.3s ease';
          nameDiv.style.zIndex = '10';
          nameDiv.textContent = approver;
          nameDiv.title = '–ö–ª–∏–∫ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤';
          
          // –î–æ–±–∞–≤–ª—è–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç
          nameDiv.addEventListener('mouseenter', () => {
            nameDiv.style.backgroundColor = 'rgba(0, 123, 255, 0.2)';
            nameDiv.style.transform = 'translateY(-50%) scale(1.05)';
          });
          
          nameDiv.addEventListener('mouseleave', () => {
            nameDiv.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
            nameDiv.style.transform = 'translateY(-50%) scale(1)';
          });
          
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
          nameDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–∏
            const existingResults = companyContainer.querySelectorAll('.approver-results');
            existingResults.forEach(result => {
              result.classList.remove('show');
              setTimeout(() => {
                if (result.parentNode) {
                  result.parentNode.removeChild(result);
                }
              }, 300);
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ–¥ –µ–≥–æ —Ç–∞–π–º–ª–∞–π–Ω–æ–º
            showApproverResults(approver, employeeRow);
          });
          
          track.appendChild(nameDiv);

          // –ë–µ–π–¥–∂ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ —Å–ø—Ä–∞–≤–∞ (–¢–°–î, –£–ë–û–†–ö–ê, –ó–∞–º–æ—Ä–æ–∑–∫–∞, –ü–∞–ª–ª–µ—Ç—ã)
          const assignmentDiv = document.createElement('div');
          assignmentDiv.className = 'position-absolute';
          assignmentDiv.style.right = '10px';
          assignmentDiv.style.top = '50%';
          assignmentDiv.style.transform = 'translateY(-50%)';
          assignmentDiv.style.fontSize = '0.75rem';
          assignmentDiv.style.fontWeight = '600';
          assignmentDiv.style.color = '#495057';
          assignmentDiv.style.padding = '4px 8px';
          assignmentDiv.style.borderRadius = '4px';
          assignmentDiv.style.backgroundColor = 'rgba(40, 167, 69, 0.10)';
          assignmentDiv.style.cursor = 'pointer';
          assignmentDiv.style.transition = 'all 0.3s ease';
          assignmentDiv.title = '–ö–ª–∏–∫ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–Ω—è—Ç–æ—Å—Ç–∏';

          const currentAssignment = approverToAssignment[approver] || '–¢–°–î';
          assignmentDiv.textContent = currentAssignment;

          assignmentDiv.addEventListener('mouseenter', () => {
            assignmentDiv.style.backgroundColor = 'rgba(40, 167, 69, 0.18)';
          });
          assignmentDiv.addEventListener('mouseleave', () => {
            assignmentDiv.style.backgroundColor = 'rgba(40, 167, 69, 0.10)';
          });

          // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –ø–æ –∫–ª–∏–∫—É
          assignmentDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            const select = document.createElement('select');
            select.className = 'form-select form-select-sm';
            select.style.position = 'absolute';
            select.style.right = '0';
            select.style.top = '50%';
            select.style.transform = 'translateY(-50%)';
            select.style.width = '160px';
            select.style.zIndex = '20';

            const options = ['–ù–µ –∑–∞–¥–∞–Ω–æ', '–¢–°–î', '–£–ë–û–†–ö–ê', '–ó–∞–º–æ—Ä–æ–∑–∫–∞', '–ü–∞–ª–ª–µ—Ç—ã'];
            options.forEach(opt => {
              const o = document.createElement('option');
              o.value = opt;
              o.textContent = opt;
              if (opt === assignmentDiv.textContent) o.selected = true;
              select.appendChild(o);
            });

            const closeSelect = () => {
              if (select && select.parentNode) select.parentNode.removeChild(select);
            };

            select.addEventListener('change', () => {
              assignmentDiv.textContent = select.value;
              approverToAssignment[approver] = select.value;
              // –û–±–Ω–æ–≤–∏–º –∏ –≤ recordsData, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ—Å—å –≤ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è—Ö, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
              const rec = (recordsData || []).find(r => r['–£—Ç–≤–µ—Ä–¥–∏–ª'] === approver);
              if (rec) rec['–ó–∞–Ω—è—Ç–æ—Å—Ç—å'] = select.value;
              closeSelect();
            });
            select.addEventListener('blur', closeSelect);

            assignmentDiv.parentNode.appendChild(select);
            select.focus();
          });

          track.appendChild(assignmentDiv);
          employeeRow.appendChild(track);
          companyContainer.appendChild(employeeRow);

        // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã —á–µ—Ä–µ–∑ –≤—Å–µ —Ç–∞–π–º–ª–∞–π–Ω—ã: 12:00, 15:00, 17:00, 19:00
        const verticalLines = [12, 15, 17, 19];
        verticalLines.forEach(hh => {
          const line = document.createElement('div');
          line.className = 'position-absolute';
          line.style.left = (((hh*60 - dayStartMin) / totalMinutes) * 100) + '%';
          line.style.top = '0';
          line.style.width = '1px';
          line.style.height = '100%';
          line.style.background = '#dee2e6';
          line.style.opacity = '0.7';
          track.appendChild(line);
        });
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–µ–ª–µ–Ω—ã–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã: 10:50, 16:50, 18:50
        const greenLines = [
          { hour: 10, minute: 50 },
          { hour: 16, minute: 50 },
          { hour: 18, minute: 50 }
        ];
        greenLines.forEach(time => {
          const totalMinutesFromStart = time.hour * 60 + time.minute;
          const line = document.createElement('div');
          line.className = 'position-absolute';
          line.style.left = (((totalMinutesFromStart - dayStartMin) / totalMinutes) * 100) + '%';
          line.style.top = '0';
          line.style.width = '1px';
          line.style.height = '100%';
          line.style.background = '#28a745';
          line.style.opacity = '0.8';
          track.appendChild(line);
        });

        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–π
        const timePositions = new Set();
        const timeMarks = [];
        
        // –°–Ω–∞—á–∞–ª–∞ —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
        list.forEach(it => {
          const startStr = pickRawTime(it.before || {});
          const endStr = pickRawTime(it.after || {});
          const startMinAbs = timeToMinutes(startStr);
          const endMinAbs = timeToMinutes(endStr);
          if (startMinAbs == null || endMinAbs == null) return;
          
          let startAdj = Math.max(dayStartMin, Math.min(dayEndMin, startMinAbs));
          let endAdj = Math.max(dayStartMin, Math.min(dayEndMin, endMinAbs));
          if (endAdj <= startAdj) return;
          
          const leftPct = ((startAdj - dayStartMin) / totalMinutes) * 100;
          const widthPct = Math.max(2.0, ((endAdj - startAdj) / totalMinutes) * 100);
          
          timeMarks.push({
            startStr, endStr, leftPct, widthPct, 
            startAdj, endAdj, bucket: Number(it.bucket), duration: it.duration
          });
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ–∑–∏—Ü–∏–∏
        const adjustPosition = (position) => {
          const minDistance = 3; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –º–µ—Ç–∫–∞–º–∏ –≤ %
          let adjustedPos = position;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–∑–∏—Ü–∏–π
          for (const existingPos of timePositions) {
            if (Math.abs(adjustedPos - existingPos) < minDistance) {
              // –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ, —Å–¥–≤–∏–≥–∞–µ–º –≤–ø—Ä–∞–≤–æ
              adjustedPos = existingPos + minDistance;
            }
          }
          
          timePositions.add(adjustedPos);
          return adjustedPos;
        };
        
        // –°–æ–∑–¥–∞–µ–º –±–ª–æ–∫–∏ –∏ –∑–∞—Å–µ—á–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
        timeMarks.forEach(it => {
          const block = document.createElement('div');
          block.className = 'position-absolute text-dark d-flex align-items-center justify-content-center timeline-block';
          block.style.left = it.leftPct + '%';
          block.style.top = '20px';
          block.style.height = '24px';
          block.style.width = it.widthPct + '%';
          
          // –¶–≤–µ—Ç –ø–æ –±–∞–∫–µ—Ç—É
          let color = '#6c757d';
          if (it.bucket >= 45) color = '#dc3545';
          else if (it.bucket >= 30) color = '#fd7e14';
          else if (it.bucket >= 15) color = '#ffc107';
          
          block.style.background = color;
          block.style.borderRadius = '4px';
          block.style.fontSize = '0.75rem';
          block.title = `${it.startStr}‚Äì${it.endStr} (${it.duration})`;
          
          // –î–ª—è –ø—Ä–æ—Å—Ç–æ–µ–≤ –±–æ–ª–µ–µ 45 –º–∏–Ω—É—Ç –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –≤–Ω—É—Ç—Ä—å –±–ª–æ–∫–∞
          if (it.bucket >= 45) {
            block.textContent = `${it.startStr}‚Äì${it.endStr}`;
            block.style.color = '#ffffff';
            block.style.fontWeight = '500';
            block.style.fontSize = '0.7rem';
          }
          
          track.appendChild(block);
          
          // –°–æ–∑–¥–∞–µ–º –∑–∞—Å–µ—á–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –±–ª–æ–∫–æ–≤ –º–µ–Ω–µ–µ 45 –º–∏–Ω—É—Ç)
          if (it.bucket < 45) {
            // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –±–ª–æ–∫–∞
            const blockCenter = it.leftPct + (it.widthPct / 2);
            
            // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å–≤–µ—Ä—Ö—É –±–ª–æ–∫–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É
            const startTimeLabel = document.createElement('div');
            startTimeLabel.className = 'position-absolute';
            startTimeLabel.style.left = blockCenter + '%';
            startTimeLabel.style.top = '2px';
            startTimeLabel.style.transform = 'translateX(-50%)';
            startTimeLabel.style.fontSize = '0.6rem';
            startTimeLabel.style.color = '#495057';
            startTimeLabel.style.fontWeight = '500';
            startTimeLabel.style.backgroundColor = 'rgba(255, 255, 255, 0.95)';
            startTimeLabel.style.padding = '1px 3px';
            startTimeLabel.style.borderRadius = '2px';
            startTimeLabel.style.border = '1px solid #dee2e6';
            startTimeLabel.style.zIndex = '5'; // –ü–æ–≤–µ—Ä—Ö –±–ª–æ–∫–æ–≤ –ø—Ä–æ—Å—Ç–æ–µ–≤
            startTimeLabel.textContent = it.startStr;
            track.appendChild(startTimeLabel);
            
            // –í—Ä–µ–º—è –∫–æ–Ω—Ü–∞ —Å–Ω–∏–∑—É –±–ª–æ–∫–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É
            const endTimeLabel = document.createElement('div');
            endTimeLabel.className = 'position-absolute';
            endTimeLabel.style.left = blockCenter + '%';
            endTimeLabel.style.top = '30px';
            endTimeLabel.style.transform = 'translateX(-50%)';
            endTimeLabel.style.fontSize = '0.6rem';
            endTimeLabel.style.color = '#495057';
            endTimeLabel.style.fontWeight = '500';
            endTimeLabel.style.backgroundColor = 'rgba(255, 255, 255, 0.95)';
            endTimeLabel.style.padding = '1px 3px';
            endTimeLabel.style.borderRadius = '2px';
            endTimeLabel.style.border = '1px solid #dee2e6';
            endTimeLabel.style.zIndex = '5'; // –ü–æ–≤–µ—Ä—Ö –±–ª–æ–∫–æ–≤ –ø—Ä–æ—Å—Ç–æ–µ–≤
            endTimeLabel.textContent = it.endStr;
            track.appendChild(endTimeLabel);
          }
        });
        });
      });
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const table = document.getElementById('results-table');
    const tbody = document.getElementById('results-tbody');
    let sortState = { col: null, asc: true };

    function getCellValue(row, idx) {
      const cell = row.querySelectorAll('td')[idx];
      if (!cell) return '';
      return (cell.innerText || '').trim();
    }

    function asNumberOrString(v) {
      const normalized = (v || '').replace(/\s+/g, '').replace(',', '.');
      const num = Number(normalized);
      return Number.isFinite(num) ? num : (v || '').toLowerCase();
    }

    function attachDetailRows(row, fragment) {
      const approver = row.getAttribute('data-approver');
      const details = document.querySelectorAll(`tr.details-row[data-approver="${approver}"]`);
      fragment.appendChild(row);
      details.forEach(d => fragment.appendChild(d));
    }

    function sortByColumn(colIdx) {
      const rows = Array.from(document.querySelectorAll('#results-tbody tr.main-row'));
      const asc = sortState.col === colIdx ? !sortState.asc : true;
      sortState = { col: colIdx, asc };

      rows.sort((a, b) => {
        const va = asNumberOrString(getCellValue(a, colIdx));
        const vb = asNumberOrString(getCellValue(b, colIdx));
        if (va < vb) return asc ? -1 : 1;
        if (va > vb) return asc ? 1 : -1;
        return 0;
      });

      const frag = document.createDocumentFragment();
      rows.forEach(r => attachDetailRows(r, frag));
      tbody.innerHTML = '';
      tbody.appendChild(frag);
      // –û–±–Ω–æ–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é –ø–æ—Å–ª–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
      if (typeof updateResultsNumbering === 'function') {
        updateResultsNumbering();
      }
    }

    if (table) {
      table.querySelectorAll('th.sortable').forEach(th => {
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => sortByColumn(Number(th.getAttribute('data-col'))));
      });
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã" (–ø–æ –∫–ª–∏–∫—É –Ω–∞ —è—á–µ–π–∫—É –∫–æ–º–ø–∞–Ω–∏–∏)
    let resultsCompanyFilter = null;
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã" —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    function updateResultsNumbering() {
      const mainRows = Array.from(document.querySelectorAll('#results-tbody tr.main-row'));
      let rowNumber = 1;
      mainRows.forEach(r => {
        if (!r.classList.contains('d-none')) {
          const numberCell = r.querySelector('td:first-child');
          if (numberCell) {
            const rowNumberDiv = numberCell.querySelector('.row-number');
            if (rowNumberDiv) {
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫—É–±–æ–∫, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
              const trophySpan = numberCell.querySelector('.trophy-icon');
              const trophyHtml = trophySpan ? trophySpan.outerHTML : '';
              rowNumberDiv.innerHTML = `#${rowNumber}`;
              // –ï—Å–ª–∏ –±—ã–ª –∫—É–±–æ–∫, –≤—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ
              if (trophySpan && numberCell.querySelector('.trophy-icon') === null) {
                numberCell.insertBefore(trophySpan, rowNumberDiv);
              }
            }
          }
          rowNumber++;
        }
      });
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä company_name –≤ URL
    function applyCompanyFilter(companyName) {
      if (!companyName) {
        resultsCompanyFilter = null;
      } else {
        resultsCompanyFilter = companyName;
      }
      const mainRows = Array.from(document.querySelectorAll('#results-tbody tr.main-row'));
      mainRows.forEach(r => {
        const compCell = r.querySelector('td.col-company');
        const comp = (compCell && compCell.innerText) ? compCell.innerText.trim() : '';
        const show = !resultsCompanyFilter || comp === resultsCompanyFilter;
        r.classList.toggle('d-none', !show);
        const approver = r.getAttribute('data-approver');
        document.querySelectorAll(`tr.details-row[data-approver="${approver}"]`).forEach(dr => {
          dr.classList.toggle('d-none', !show);
        });
      });
      // –û–±–Ω–æ–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
      updateResultsNumbering();
      // –¢–∞–∫–∂–µ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è hourly –∏ downtimes
      if (typeof renderHourlyTable === 'function') {
        renderHourlyTable();
      }
      if (typeof buildDowntimesTimeline === 'function') {
        buildDowntimesTimeline();
      }
    }
    
    // –ß–∏—Ç–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä company_name –∏–∑ URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const urlParams = new URLSearchParams(window.location.search);
    const companyNameFromUrl = urlParams.get('company_name');
    if (companyNameFromUrl) {
      applyCompanyFilter(companyNameFromUrl);
    } else {
      // –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω, –≤—Å–µ —Ä–∞–≤–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é
      updateResultsNumbering();
    }
    
    document.addEventListener('click', (e) => {
      const cell = e.target.closest('#results-table tbody td.col-company');
      if (!cell) return;
      const company = (cell.innerText || '').trim();
      resultsCompanyFilter = (resultsCompanyFilter === company ? null : company);
      const mainRows = Array.from(document.querySelectorAll('#results-tbody tr.main-row'));
      mainRows.forEach(r => {
        const compCell = r.querySelector('td.col-company');
        const comp = (compCell && compCell.innerText) ? compCell.innerText.trim() : '';
        const show = !resultsCompanyFilter || comp === resultsCompanyFilter;
        r.classList.toggle('d-none', !show);
        const approver = r.getAttribute('data-approver');
        document.querySelectorAll(`tr.details-row[data-approver="${approver}"]`).forEach(dr => {
          dr.classList.toggle('d-none', !show);
        });
      });
      // –û–±–Ω–æ–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
      updateResultsNumbering();
    });

    // –¢–æ–≥–≥–ª—ã –º–µ–∂–¥—É –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –ü—Ä–æ—Å—Ç–æ–∏
    // –î—É–±–ª–∏–∫–∞—Ç—ã —Ñ—É–Ω–∫—Ü–∏–π –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω—ã (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–µ—Ä—Å–∏–∏ –≤—ã—à–µ, –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã–µ –≤ –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞)
    });
  </script>
  </body>
  </html>