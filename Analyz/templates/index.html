<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Главное меню - Анализатор данных</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('favicon') }}">
    <!-- Минимальное оформление через Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
      /* Анимация клика по дате календаря */
      td.cal-click { cursor: pointer; position: relative; overflow: hidden; }
      td.cal-click .cal-day { display: inline-block; transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease; padding: 4px 8px; border-radius: 8px; }
      td.cal-click.pressed .cal-day { transform: scale(0.96); background-color: rgba(13,110,253,.08); box-shadow: 0 0 0 2px rgba(13,110,253,.15) inset; }

      /* Ripple-эффект */
      .ripple {
        position: absolute;
        border-radius: 50%;
        transform: scale(0);
        opacity: 0.45;
        background: rgba(13, 110, 253, 0.45);
        pointer-events: none;
        animation: ripple-spread .45s ease-out forwards;
      }
      @keyframes ripple-spread {
        to { transform: scale(1); opacity: 0; }
      }

      /* Ровная сетка календаря: одинаковые блоки дней */
      #calendar table { table-layout: fixed; width: 100%; }
      #calendar thead th { text-align: center; }
      #calendar tbody td { height: 64px; padding: 4px; }
      #calendar tbody td .cal-day {
        display: flex; align-items: center; justify-content: center;
        width: 100%; height: 100%; padding: 0; border-radius: 8px;
      }
      
      /* Компактная форма анализа */
      #analysisForm .card-body {
        padding: 0.75rem;
      }
      #analysisForm .form-label {
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
      }
      #analysisForm .form-control {
        padding: 0.375rem 0.5rem;
        font-size: 0.9rem;
      }
      #analysisForm .form-text {
        font-size: 0.75rem;
        margin-top: 0.25rem;
      }
      #analysisForm .mb-3 {
        margin-bottom: 0.75rem !important;
      }
      #analysisForm .card-header {
        padding: 0.5rem 0.75rem;
      }
      #analysisForm .card-header h5 {
        font-size: 1rem;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mb-3">
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- Форма анализа данных и календарь в одном ряду -->
      <div class="row mt-4">
        <div class="col-md-5">
          <div class="card h-100" id="analysisForm">
            <div class="card-header">
              <h5 class="mb-0">Анализ данных (CSV/XLSX)</h5>
            </div>
            <div class="card-body">
              <form action="{{ url_for('analyze') }}" method="post" enctype="multipart/form-data">
                <div class="mb-3">
                  <label for="file" class="form-label">Выберите файл (CSV или XLSX)</label>
                  <input class="form-control" type="file" id="file" name="file" accept=".csv,.xlsx,.xls" required>
                  <div class="form-text">Поддерживаются CSV и Excel файлы с нужными полями.</div>
                </div>
                <div class="mb-3">
                  <label for="date" class="form-label">Дата (для помесячной статистики)</label>
                  <input class="form-control" type="date" id="date" name="date" value="{{ current_date }}">
                  <div class="form-text">Если указать дату, файл добавится к этой дате и будет анализироваться только она.</div>
                </div>
                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-primary btn-sm">Добавить и анализировать</button>
                  <button type="button" class="btn btn-outline-danger btn-sm ms-auto" onclick="confirmClear()">Очистить накопленные</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="col-md-7">
          <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Календарь загруженных дней</h5>
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-outline-secondary" type="button" onclick="prevMonth()">◀</button>
                <div id="cal-title" class="fw-semibold"></div>
                <button class="btn btn-sm btn-outline-secondary" type="button" onclick="nextMonth()">▶</button>
                <button class="btn btn-sm btn-outline-primary ms-2" type="button" onclick="refreshDays()">Обновить</button>
              </div>
            </div>
            <div class="card-body">
              <div id="calendar" class="table-responsive">
                <table class="table table-bordered table-sm align-middle mb-0" style="min-width: 420px;">
                  <thead>
                    <tr class="text-center">
                      <th class="text-muted">Пн</th>
                      <th class="text-muted">Вт</th>
                      <th class="text-muted">Ср</th>
                      <th class="text-muted">Чт</th>
                      <th class="text-muted">Пт</th>
                      <th class="text-muted">Сб</th>
                      <th class="text-muted">Вс</th>
                    </tr>
                  </thead>
                  <tbody id="cal-body"></tbody>
                </table>
              </div>
              <div class="small text-muted mt-2">Клик по дате с точкой открывает отчёт за этот день.</div>
            </div>
          </div>
        </div>
      </div>
      <!-- Modal итогов дня -->
      <div class="modal fade" id="daySummaryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Итоги дня</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div id="day-summary-content">Загрузка...</div>
            </div>
            <div class="modal-footer">
              <a id="day-summary-open" class="btn btn-primary" href="#">Открыть отчёт</a>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  <!-- Floating settings button -->
  <button type="button" class="btn btn-primary position-fixed" style="right: 20px; bottom: 20px; border-radius: 50%; width: 56px; height: 56px;" data-bs-toggle="modal" data-bs-target="#settingsModal">⚙️</button>

  <!-- Settings Modal -->
  <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="settingsModalLabel">Настройки: сотрудники и компании</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form action="{{ url_for('upload_employees') }}" method="post" enctype="multipart/form-data">
            <div class="mb-3">
              <label for="employeesFile" class="form-label">Загрузить CSV сотрудников</label>
              <input class="form-control" type="file" id="employeesFile" name="file" accept=".csv" required>
              <div class="form-text">Столбцы: "Утвердил", "Компания", опционально "ФИО".</div>
            </div>
            <button type="submit" class="btn btn-primary">Сохранить</button>
          </form>
        </div>
      </div>
    </div>
  </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function showAnalysisForm() {
        document.getElementById('analysisForm').style.display = 'block';
        document.getElementById('analysisForm').scrollIntoView({ behavior: 'smooth' });
      }
      
      function hideAnalysisForm() {
        document.getElementById('analysisForm').style.display = 'none';
      }

  function confirmClear() {
    const dateInput = document.getElementById('date');
    const dateVal = dateInput ? (dateInput.value || '') : '';
    const target = dateVal ? `данные за ${dateVal}` : 'общие накопленные данные';
    if (!confirm(`Очистить ${target}?`)) return;
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("clear_accumulator") }}';
    if (dateVal) {
      const f = document.createElement('input');
      f.type = 'hidden';
      f.name = 'date';
      f.value = dateVal;
      form.appendChild(f);
    }
    document.body.appendChild(form);
    form.submit();
  }

  async function refreshDays() {
    const box = document.getElementById('days-list');
    if (!box) return;
    box.textContent = 'Загрузка...';
    try {
      const res = await fetch('{{ url_for("list_days") }}');
      const data = await res.json();
      const days = (data && Array.isArray(data.days)) ? data.days : [];
      if (!days.length) { box.textContent = 'Нет загруженных дней.'; return; }
      const frag = document.createDocumentFragment();
      days.forEach(d => {
        const btn = document.createElement('a');
        btn.className = 'btn btn-sm btn-outline-secondary';
        btn.href = '{{ url_for("analyze_day", date_str="") }}' + d;
        btn.textContent = d;
        frag.appendChild(btn);
      });
      box.innerHTML = '';
      box.appendChild(frag);
    } catch (e) {
      box.textContent = 'Не удалось загрузить список дней';
    }
  }

  document.addEventListener('DOMContentLoaded', refreshDays);
  
  // Сохраняем company_name из URL в sessionStorage, если он есть
  const urlParams = new URLSearchParams(window.location.search);
  const companyNameFromUrl = urlParams.get('company_name');
  if (companyNameFromUrl) {
    sessionStorage.setItem('analyz_company_name', companyNameFromUrl);
  }
  
  // Календарь
  const calState = {
    year: new Date().getFullYear(),
    month: new Date().getMonth(), // 0-11
    daysWithData: new Set(), // 'YYYY-MM-DD'
  };

  function ymd(date) {
    const y = date.getFullYear();
    const m = (date.getMonth() + 1).toString().padStart(2, '0');
    const d = date.getDate().toString().padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  async function refreshDays() {
    const box = document.getElementById('days-list');
    if (box) box.textContent = '';
    try {
      const res = await fetch('{{ url_for("list_days") }}');
      const data = await res.json();
      const days = (data && Array.isArray(data.days)) ? data.days : [];
      calState.daysWithData = new Set(days);
      renderCalendar();
    } catch (e) {
      // noop
    }
  }

  function renderCalendar() {
    const title = document.getElementById('cal-title');
    const body = document.getElementById('cal-body');
    if (!(title && body)) return;
    const first = new Date(calState.year, calState.month, 1);
    const monthNames = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
    title.textContent = `${monthNames[calState.month]} ${calState.year}`;

    // Определяем смещение (сделаем неделя начинается с Пн)
    let startIdx = first.getDay(); // 0=Вс,1=Пн,...
    startIdx = (startIdx === 0 ? 6 : startIdx - 1); // 0..6 где 0 = Пн
    const daysInMonth = new Date(calState.year, calState.month + 1, 0).getDate();

    const rows = [];
    let cells = [];
    // Пустые ячейки до первого дня
    for (let i = 0; i < startIdx; i++) cells.push('<td class="text-muted"></td>');

    for (let day = 1; day <= daysInMonth; day++) {
      const dt = new Date(calState.year, calState.month, day);
      const id = ymd(dt);
      const has = calState.daysWithData.has(id);
      const mark = has ? '<span class="ms-1 text-primary">•</span>' : '';
      const cls = has ? 'fw-semibold' : 'text-muted';
      let href = "{{ url_for('analyze_day', date_str='') }}" + id;
      // Добавляем company_name к URL, если он сохранен в sessionStorage
      const savedCompanyName = sessionStorage.getItem('analyz_company_name');
      if (savedCompanyName) {
        href += '?company_name=' + encodeURIComponent(savedCompanyName);
      }
      const attrs = has ? ` class="text-center align-middle cal-click" data-href="${href}"` : ' class="text-center align-middle"';
      cells.push(`<td${attrs} style="height:56px"><div class="cal-day ${cls}">${day}${mark}</div></td>`);
      if (cells.length === 7) { rows.push(`<tr>${cells.join('')}</tr>`); cells = []; }
    }
    // Добиваем ряд пустыми ячейками
    while (cells.length && cells.length < 7) cells.push('<td></td>');
    if (cells.length) rows.push(`<tr>${cells.join('')}</tr>`);
    body.innerHTML = rows.join('');
  }

  function prevMonth() {
    calState.month -= 1;
    if (calState.month < 0) { calState.month = 11; calState.year -= 1; }
    renderCalendar();
  }
  function nextMonth() {
    calState.month += 1;
    if (calState.month > 11) { calState.month = 0; calState.year += 1; }
    renderCalendar();
  }

  document.addEventListener('DOMContentLoaded', () => {
    refreshDays();
    renderCalendar();
    // Автоматическое обновление календаря каждые 30 секунд
    setInterval(() => {
      refreshDays();
    }, 30000);
    // Делегированный клик по дням календаря с анимацией
    document.addEventListener('click', async (e) => {
      const td = e.target.closest('td.cal-click');
      if (!td) return;
      const href = td.getAttribute('data-href');
      if (!href) return;
      // pressed-анимация + ripple
      td.classList.add('pressed');
      const rect = td.getBoundingClientRect();
      const ripple = document.createElement('span');
      const size = Math.max(rect.width, rect.height) * 1.2;
      ripple.className = 'ripple';
      ripple.style.width = ripple.style.height = `${size}px`;
      const cx = (e.clientX - rect.left) - size/2;
      const cy = (e.clientY - rect.top) - size/2;
      ripple.style.left = `${cx}px`;
      ripple.style.top = `${cy}px`;
      td.appendChild(ripple);

      // Показываем модалку итогов вместо немедленного перехода
      try {
        const dateStr = href.split('/').pop();
        const res = await fetch(`{{ url_for('day_summary', date_str='__DATE__') }}`.replace('__DATE__', dateStr));
        const data = await res.json();
        const modalEl = document.getElementById('daySummaryModal');
        const content = document.getElementById('day-summary-content');
        const openBtn = document.getElementById('day-summary-open');
        if (res.ok && data && !data.error) {
          const by = data.by_company || {};
          content.innerHTML = `
            <div class="mb-2"><strong>Дата:</strong> ${data.date || ''}</div>
            <div class="mb-1"><strong>Задач всего:</strong> ${data.total_tasks || 0}</div>
            <div class="mb-1"><strong>Вес, кг:</strong> ${Number(data.total_weight || 0).toLocaleString('ru-RU')}</div>
            <hr class="my-2"/>
            <div class="mb-1"><strong>Штат:</strong> ${by['Штат'] || 0}</div>
            <div class="mb-1"><strong>Мувинг:</strong> ${by['Мувинг'] || 0}</div>
            <div class="mb-1"><strong>Градус:</strong> ${by['Градус'] || 0}</div>
            <div class="mb-1"><strong>Два Колеса:</strong> ${by['Два Колеса'] || 0}</div>
            <div class="mb-1"><strong>Без компании:</strong> ${by['без компании'] || 0}</div>
            <hr class="my-2"/>
            <div class="mb-1"><strong>Окончание задач:</strong> ${data.latest_finish || '—'}</div>
          `;
        } else {
          content.textContent = 'Нет данных за выбранный день.';
        }
        if (openBtn) openBtn.href = href;
        if (modalEl) new bootstrap.Modal(modalEl).show();
      } catch (err) {
        // если ошибка — просто переходим
        window.location.href = href;
      }
      // Удаляем ripple позже
      setTimeout(() => { if (ripple && ripple.parentNode) ripple.parentNode.removeChild(ripple); }, 600);
    });
  });
    </script>
  </body>
  </html>



