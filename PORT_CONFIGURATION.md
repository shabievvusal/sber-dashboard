# Конфигурация портов

## Важно: Разница между внутренними и внешними портами

В Docker Compose есть два типа портов:
1. **Внутренние порты** (внутри Docker сети) - всегда стандартные: 5000, 5050, 80
2. **Внешние порты** (доступ с хоста) - настраиваются через `.env`

## Текущая конфигурация

### Внутри Docker сети (между контейнерами)
- **Backend**: `http://backend:5000` (внутренний порт всегда 5000)
- **Analyz**: `http://analyz:5050` (внутренний порт всегда 5050)
- **Frontend**: `http://frontend:80` (внутренний порт всегда 80)

### Снаружи (с вашего компьютера)
Настраиваются через `.env`:
- **Frontend**: `http://localhost:${FRONTEND_PORT}` (по умолчанию 3000, у вас 3001)
- **Backend**: `http://localhost:${BACKEND_PORT}` (по умолчанию 5000, у вас 5001)
- **Analyz**: `http://localhost:${ANALYZ_PORT}` (по умолчанию 5050, у вас 5051)

## Ваш .env файл

```env
FRONTEND_PORT=3001    # Внешний порт для frontend
BACKEND_PORT=5001    # Внешний порт для backend
ANALYZ_PORT=5051     # Внешний порт для analyz

# ВАЖНО: ANALYZ_SERVICE_URL используется только для доступа с хоста
# Внутри Docker всегда используется http://analyz:5050
ANALYZ_SERVICE_URL=http://localhost:5051
```

## Как это работает

### Маппинг портов в docker-compose.yml

```yaml
backend:
  ports:
    - "${BACKEND_PORT:-5000}:5000"
    # Внешний:Внутренний
    # 5001:5000 означает:
    # - Снаружи доступен на порту 5001
    # - Внутри контейнера слушает на порту 5000
```

### Связь между контейнерами

Когда backend обращается к Analyz, он использует:
- `http://analyz:5050` (внутренний адрес Docker сети)

Когда вы обращаетесь с браузера, используйте:
- `http://localhost:3001` (frontend)
- `http://localhost:5001` (backend API)
- `http://localhost:5051` (Analyz напрямую, если нужно)

## Проверка конфигурации

### 1. Проверьте, что порты не заняты

```bash
# Windows PowerShell
netstat -ano | findstr :3001
netstat -ano | findstr :5001
netstat -ano | findstr :5051
```

### 2. Проверьте доступность сервисов

```bash
# Frontend
curl http://localhost:3001

# Backend
curl http://localhost:5001/health

# Analyz (если нужен прямой доступ)
curl http://localhost:5051/health
```

### 3. Проверьте логи

```bash
docker compose logs backend | grep "Server running"
docker compose logs analyz | grep "Running on"
```

## Частые проблемы

### Проблема: Порт уже занят

**Решение**: Измените порт в `.env` или освободите занятый порт

```env
FRONTEND_PORT=3002  # Если 3001 занят
```

### Проблема: Backend не может подключиться к Analyz

**Причина**: Использован внешний адрес вместо внутреннего

**Неправильно**:
```yaml
ANALYZ_SERVICE_URL=http://localhost:5051  # ❌ Не работает внутри Docker
```

**Правильно**:
```yaml
ANALYZ_SERVICE_URL=http://analyz:5050  # ✅ Работает внутри Docker сети
```

### Проблема: Frontend не может подключиться к Backend

**Решение**: Убедитесь, что в `frontend/nginx.conf` или переменных окружения frontend используется правильный адрес:

- В Docker: `http://backend:5000`
- С хоста (для разработки): `http://localhost:5001`

## Рекомендации

1. **Для продакшена**: Используйте стандартные порты (3000, 5000, 5050) или настройте reverse proxy (nginx)
2. **Для разработки**: Можно использовать любые свободные порты через `.env`
3. **Внутри Docker**: Всегда используйте внутренние адреса (`backend:5000`, `analyz:5050`)

## Текущий статус

Судя по логам, все работает правильно:
- ✅ Все контейнеры запущены и здоровы
- ✅ Health checks проходят успешно
- ✅ Проксирование работает корректно
- ✅ Запросы проходят через backend к Analyz

Ваша конфигурация с портами 3001, 5001, 5051 работает корректно!

